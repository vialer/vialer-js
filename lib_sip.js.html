
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Source: lib/sip.js | Vialer-js</title>
    <link type="text/css" rel="stylesheet" href="styles/font-awesome.min.css">
    <link type="text/css" rel="stylesheet" href="styles/main.css">

    
</head>
<body>
<div class="main-container">
    <input type="checkbox" id="nav-trigger" class="nav-trigger">
    <label for="nav-trigger" class="navicon-button x">
      <div class="navicon"></div>
    </label>
    <label for="nav-trigger" class="overlay"></label>
    <nav class="lnb" id="lnb">
        <div class="nav-search js-search">
            <div class="logo" style="width: 72px; height: 72px">
                <img src="logo-64.png" width="100%" height="100%">
            </div>
            <input type="text" placeholder="Search docs">
            <ul class="searched-list"></ul>
        </div>

        <div class="nav-main">
            <h1><a href="index.html" class="link">Vialer-js</a></h1>
            <span class="version">
            
                v2.0.12
            
            </span>
        </div>

        
        <ol class="nav-tab">
            <li id="api-tab">
                <a href="#api"><h4>Code</h4></a>
            </li>
            <li id="manuals-tab">
                <a href="#manuals"><h4>Manuals</h4></a>
            </li>
        </ol>
        

        <div class="scroll">
        <div class="nav-api hidden"><h3>Global</h3><ul><li class="nav-item"><a href="global.html#jitter">jitter</a></li><li class="nav-item"><a href="global.html#VialerApp">VialerApp</a></li></ul></div><div class="nav-manuals hidden"><h3>Manuals</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-deployment.html">Deployment</a>
                <div class="nav-item-sub hidden" id="deployment_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-development.html">Development</a>
                <div class="nav-item-sub hidden" id="development_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-install.html">Installation</a>
                <div class="nav-item-sub hidden" id="install_sub"></div>
            </li></ul></div><div class="nav-api hidden"><h3>Modules</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability.html">Availability</a>
                <div class="nav-item-sub hidden" id="module_Availability_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts.html">Contacts</a>
                <div class="nav-item-sub hidden" id="module_Contacts_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer.html">Dialer</a>
                <div class="nav-item-sub hidden" id="module_Dialer_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer.html">Observer</a>
                <div class="nav-item-sub hidden" id="module_Observer_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer.html#~getBlockedRoles">getBlockedRoles</a></a></li><li class="sub-nav-item"><a href="module-Observer.html#~getBlockedTagNames">getBlockedTagNames</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues.html">Queues</a>
                <div class="nav-item-sub hidden" id="module_Queues_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui.html">Ui</a>
                <div class="nav-item-sub hidden" id="module_Ui_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User.html">User</a>
                <div class="nav-item-sub hidden" id="module_User_sub"></div>
            </li></ul></div><div class="nav-api hidden"><h3>Classes</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Actions.html">Actions</a>
                <div class="nav-item-sub hidden" id="Actions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Analytics.html">Analytics</a>
                <div class="nav-item-sub hidden" id="Analytics_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Analytics.html#trackClickToDial">trackClickToDial</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Api.html">Api</a>
                <div class="nav-item-sub hidden" id="Api_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Api.html#setupClient">setupClient</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="App.html">App</a>
                <div class="nav-item-sub hidden" id="App_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="App.html#_init">_init</a></a></li><li class="sub-nav-item"><a href="App.html#getPlatformUrl">getPlatformUrl</a></a></li><li class="sub-nav-item"><a href="App.html#reloadModules">reloadModules</a></a></li><li class="sub-nav-item"><a href="App.html#resetModules">resetModules</a></a></li><li class="sub-nav-item"><a href="App.html#restoreModules">restoreModules</a></a></li><li class="sub-nav-item"><a href="App.html#version">version</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="CallStatusApp.html">CallStatusApp</a>
                <div class="nav-item-sub hidden" id="CallStatusApp_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Logger.html">Logger</a>
                <div class="nav-item-sub hidden" id="Logger_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability-AvailabilityActions.html">AvailabilityActions</a>
                <div class="nav-item-sub hidden" id="module_Availability_AvailabilityActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Availability-AvailabilityActions.html#_background">_background</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityActions.html#_popup">_popup</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability-AvailabilityModule.html">AvailabilityModule</a>
                <div class="nav-item-sub hidden" id="module_Availability_AvailabilityModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#_load">_load</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#_restore">_restore</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#availabilityOptions">availabilityOptions</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#toggleAvailabilitySelect">toggleAvailabilitySelect</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts-ContactsActions.html">ContactsActions</a>
                <div class="nav-item-sub hidden" id="module_Contacts_ContactsActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts-ContactsModule.html">ContactsModule</a>
                <div class="nav-item-sub hidden" id="module_Contacts_ContactsModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Contacts-ContactsModule.html#_load">_load</a></a></li><li class="sub-nav-item"><a href="module-Contacts-ContactsModule.html#_restore">_restore</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer-DialerActions.html">DialerActions</a>
                <div class="nav-item-sub hidden" id="module_Dialer_DialerActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer-DialerModule.html">DialerModule</a>
                <div class="nav-item-sub hidden" id="module_Dialer_DialerModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#addContextMenuItem">addContextMenuItem</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#dial">dial</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#sanitizeNumber">sanitizeNumber</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#showCallstatus">showCallstatus</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#switchObserver">switchObserver</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#trimNumber">trimNumber</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer-ObserverModule.html">ObserverModule</a>
                <div class="nav-item-sub hidden" id="module_Observer_ObserverModule_sub"><div class="member-type">Members</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#ctdNode">ctdNode</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#iconElement">iconElement</a></a></li></ul><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#createNumberIconElement">createNumberIconElement</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#escapeHTML">escapeHTML</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#handleMutations">handleMutations</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#observePage">observePage</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#processPage">processPage</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#restorePhonenumbers">restorePhonenumbers</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#stopObserver">stopObserver</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer-Walker.html">Walker</a>
                <div class="nav-item-sub hidden" id="module_Observer_Walker_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-Walker.html#isBlockedElement">isBlockedElement</a></a></li><li class="sub-nav-item"><a href="module-Observer-Walker.html#skipNode">skipNode</a></a></li><li class="sub-nav-item"><a href="module-Observer-Walker.html#walkTheDOM">walkTheDOM</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues-QueuesActions.html">QueuesActions</a>
                <div class="nav-item-sub hidden" id="module_Queues_QueuesActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Queues-QueuesActions.html#_background">_background</a></a></li><li class="sub-nav-item"><a href="module-Queues-QueuesActions.html#_popup">_popup</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues-QueuesModule.html">QueuesModule</a>
                <div class="nav-item-sub hidden" id="module_Queues_QueuesModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Queues-QueuesModule.html#setQueueSizesTimer">setQueueSizesTimer</a></a></li><li class="sub-nav-item"><a href="module-Queues-QueuesModule.html#updateQueues">updateQueues</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui-UiActions.html">UiActions</a>
                <div class="nav-item-sub hidden" id="module_Ui_UiActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Ui-UiActions.html#_checkCloseMainPanel">_checkCloseMainPanel</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui-UiModule.html">UiModule</a>
                <div class="nav-item-sub hidden" id="module_Ui_UiModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Ui-UiModule.html#busyWidget">busyWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#closeWidget">closeWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#getWidget">getWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#isWidgetOpen">isWidgetOpen</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#login">login</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#openWidget">openWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#refreshWidgets">refreshWidgets</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetLoginButton">resetLoginButton</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetWidget">resetWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetWidgetState">resetWidgetState</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#restoreWidgetState">restoreWidgetState</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#showPopup">showPopup</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#unauthorizeWidget">unauthorizeWidget</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User-UserActions.html">UserActions</a>
                <div class="nav-item-sub hidden" id="module_User_UserActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User-UserModule.html">UserModule</a>
                <div class="nav-item-sub hidden" id="module_User_UserModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-User-UserModule.html#login">login</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Sip.html">Sip</a>
                <div class="nav-item-sub hidden" id="Sip_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Sip.html#connect">connect</a></a></li><li class="sub-nav-item"><a href="Sip.html#disconnect">disconnect</a></a></li><li class="sub-nav-item"><a href="Sip.html#initStack">initStack</a></a></li><li class="sub-nav-item"><a href="Sip.html#sipStatusEvent">sipStatusEvent</a></a></li><li class="sub-nav-item"><a href="Sip.html#subscribeEvent">subscribeEvent</a></a></li><li class="sub-nav-item"><a href="Sip.html#subscribePresence">subscribePresence</a></a></li><li class="sub-nav-item"><a href="Sip.html#unsubscribePresence">unsubscribePresence</a></a></li><li class="sub-nav-item"><a href="Sip.html#updatePresence">updatePresence</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Skeleton.html">Skeleton</a>
                <div class="nav-item-sub hidden" id="Skeleton_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Skeleton.html#_init">_init</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#emit">emit</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#getEnvironment">getEnvironment</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#ipcListener">ipcListener</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#on">on</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Store.html">Store</a>
                <div class="nav-item-sub hidden" id="Store_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Timer.html">Timer</a>
                <div class="nav-item-sub hidden" id="Timer_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Timer.html#increaseTimeout">increaseTimeout</a></a></li><li class="sub-nav-item"><a href="Timer.html#setTimeout">setTimeout</a></a></li></ul></div>
            </li></ul></div>
        </div>
    </nav>

    <div class="content">
        <ul class="breadcrumbs">
            <li><a href="index.html">Docs</a> Â»</li>
            <li>Source: lib/sip.js</li>
        </ul>
        <hr>
        



    
<article>
    <pre class="prettyprint source linenums"><code>// Wait x miliseconds before resolving the subscribe event,
// to prevent the server from being hammered.
const SUBSCRIBE_DELAY = 200


/**
* The SIP class takes care of all SIP communication in the background.
* Currently this is used to check the presence of contacts.
*/
class Sip {

    /**
    * @param {ClickToDialApp} app - The application object.
    */
    constructor(app) {
        this.app = app
        // Set the verbosity of the Sip library. Useful when you need to
        // debug SIP messages. Supported values are: info, warn, error and
        // fatal.
        SIPml.setDebugLevel('error')

        this.reconnect = true
        this.states = {}
        this.subscriptions = {}
        // Start the SIP stack ASAP when logged in.
        if (app.store.get('user') &amp;&amp; app.store.get('username') &amp;&amp; app.store.get('password')) {
            this.connect()
        }
    }


    /**
     * Connect SipML5 to the websocket SIP backend.
     */
    connect() {
        // Emit to the frontend that the sip client is not yet
        // ready to start.
        if (this.status === 'started') {
            this.app.logger.warn(`${this}already connected to sip backend`)
        } else {
            this.app.logger.debug(`${this}connecting to sip backend`)
            this.app.emit('sip:before_start', {})
            if (!this._sip) this.initStack()
            else this._sip.start()
        }
    }


    /**
    * Graceful stop, do not reconnect automatically.
    * @param {Boolean} reconnect - Whether try to reconnect.
    */
    disconnect(reconnect = true) {
        this.reconnect = reconnect
        this.states = {}
        this.subscriptions = {}

        // Unsubscribe from all.
        if (this.subscriptions) {
            $.each(this.subscriptions, (accountId) => {
                this.unsubscribePresence(accountId)
            })
        }
        if (this._sip) {
            // A succesful disconnect returns 0.
            if (this._sip.stop(0) === 0) {
                this.app.logger.debug(`${this}disconnect`)
            }
        } else {
            this.app.logger.debug(`${this}not (yet) connected`)
        }
    }


    /**
    * Init and start a new stack.
    */
    initStack() {
        this.app.logger.debug(`${this}init SIP stack`)
        this.stopped = false
        // The sip stack was already initialized. Just reconnect.
        if (this._sip) {
            this.app.logger.warn(`${this}SIP stack is already active`)
            return
        }

        SIPml.init((e) => {
            this.app.logger.debug(`${this}SIP stack created`)
            let userAgent = `Click-to-dial v${this.app.version()}`
            let user = this.app.store.get('user')

            this._sip = new SIPml.Stack({
                display_name: '',
                enable_rtcweb_breaker: false,
                events_listener: {
                    events: '*',
                    listener: this.sipStatusEvent.bind(this),
                },
                impi: user.email, // authorization name (IMS Private Identity)
                impu: `sip:${user.email}@${this.app.settings.realm}`, // valid SIP Uri (IMS Public Identity)
                password: user.token,
                realm: this.app.settings.realm, // domain name
                sip_headers: [
                    { name: 'User-Agent', value: userAgent},
                    { name: 'Organization', value: 'VoIPGRID'},
                ],
                websocket_proxy_url: `wss://${this.app.settings.realm}`,
            })
            this._sip.start()
        }, (event) => {
            this.app.logger.error(`${this}failed to initialize the engine: ${event.message}`)
        })
    }


    /**
    * The SIP stack fires a new event, which is handled by this function.
    * @param {Event} e - Catch-all event when SipML UA tries to connect to
    * the websocket proxy.
    */
    sipStatusEvent(e) {
        let retryTimeoutDefault = {interval: 2500, limit: 9000000}
        if (!this.retry) this.retry = Object.assign({}, retryTimeoutDefault)
        this.status = e.type

        // Keep the websocket connection status in sync with localstorage.
        this.app.store.set('sip', {status: this.status})

        switch (e.o_event.i_code) {
        case tsip_event_code_e.STACK_STARTING:
            this.app.logger.info(`${this}SIP stack starting`)
            this.app.emit('sip:starting', {}, 'both')
            break
        case tsip_event_code_e.STACK_FAILED_TO_START:
            this.app.logger.warn(`${this}SIP stack failed to start`)
            this.app.emit('sip:failed_to_start', {}, 'both')
            if (this.reconnect) {
                setTimeout(this.connect.bind(this), this.retry.interval)
                this.retry = this.app.timer.increaseTimeout(this.retry)
            }
            break
        case tsip_event_code_e.STACK_STARTED:
            this.app.logger.info(`${this}SIP stack started`)
            // Reset the retry timer.
            this.retry = Object.assign({}, retryTimeoutDefault)
            this.app.emit('sip:started', {}, 'both')
            // Start updating presence information.
            this.updatePresence()
            break
        case tsip_event_code_e.STACK_STOPPED:
            // This event is triggered twice somehow. Flag is resetted when
            // connected again.
            if (this.stopped) {
                this.app.emit('sip:stopped', {}, 'both')

                if (this.reconnect) {
                    setTimeout(this.connect.bind(this), this.retry.interval)
                    this.retry = this.app.timer.increaseTimeout(this.retry)
                }
            }
            this.stopped = true
            break
        }
    }


    /**
    * Called multiple times for each presence subscription is registered.
    * @param {Event} e - Catch-all event when a subscribe event is triggered.
    * @param {Number} accountId - The accountId of the subscriber.
    * @param {Function} resolve - The Promise resolver function.
    */
    subscribeEvent(e, accountId, resolve) {
        if (e.type === 'connected') {
            setTimeout(() => {
                resolve({
                    accountId: accountId,
                    event: e,
                })
            }, SUBSCRIBE_DELAY)
        } else if (e.type === 'i_notify') {
            let parser = new DOMParser()
            let xmlDoc = parser ? parser.parseFromString(e.getContentString(), 'text/xml') : null
            let dialogNode = xmlDoc ? xmlDoc.getElementsByTagName('dialog-info')[0] : null
            if (dialogNode) {
                let entityUri = dialogNode.getAttribute('entity')
                let stateAttr = dialogNode.getAttribute('state')
                // let localNode = dialogNode.getElementsByTagName('local')[0]
                let stateNode = dialogNode.getElementsByTagName('state')[0]

                let state = 'unavailable'
                if (stateAttr === 'full') {
                    state = 'available'
                }

                // State node has final say, regardless of stateAttr!
                if (stateNode) {
                    switch (stateNode.textContent) {
                    case 'trying':
                    case 'proceeding':
                    case 'early':
                        state = 'ringing'
                        break
                    case 'confirmed':
                        state = 'busy'
                        break
                    case 'terminated':
                        state = 'available'
                        break
                    }
                }

                // Broadcast presence for account.
                this.app.emit('sip:presence.update', {
                    account_id: accountId,
                    state: state,
                })
                // Remember subscribed accounts and its state at the time
                // of an update.
                this.states[accountId] = {
                    entityUri: entityUri,
                    state: state,
                }
            }
        }
    }


    /**
    * Does the actual subscription to the SIP server.
    * @param {Number} accountId - Account Id of VoIP-account to subscribe to.
    * @returns {Promise} - Resolved when the subscription is ready.
    */
    subscribePresence(accountId) {
        if (this.status !== 'started') return false

        return new Promise((resolve, reject) => {
            // Keep reference to prevent subscribing multiple times.
            this.subscriptions[accountId] = this._sip.newSession('subscribe', {
                events_listener: {
                    events: '*',
                    listener: (e) => {
                        this.subscribeEvent(e, accountId, resolve)
                    },
                },
                expires: 3600,
                sip_caps: [
                    {name: '+g.oma.sip-im', value: null},
                    {name: '+audio', value: null },
                    {name: 'language', value: '\"en\"'},
                ],
                sip_headers: [
                    // Only notify for 'dialog' events.
                    {name: 'Event', value: 'dialog'},
                    // Subscribe to dialog-info.
                    {name: 'Accept', value: 'application/dialog-info+xml'},
                ],
            })

            // Start watching for entity's presence status. Make
            // sure to pass the accountId as string.
            this.subscriptions[accountId].subscribe(`${accountId}`)
        })
    }


    toString() {
        return `${this.app}[sip] `
    }


    /**
    * Stop listening for subscriber events from the SIP server and remove
    * the cached subscriber state.
    * @param {Number} accountId - The accountId to deregister.
    */
    unsubscribePresence(accountId) {
        this.app.logger.debug(`${this}unsubscribe presence ${accountId}`)
        if (this.subscriptions.hasOwnProperty(accountId)) {
            if (this._sip &amp;&amp; this._sip.o_stack.e_state === tsip_transport_state_e.STARTED) {
                this.subscriptions[accountId].unsubscribe()
            }
            delete this.subscriptions[accountId]
            delete this.states[accountId]
        }
    }


    /**
    * Update presence information for given account ids. The presence info
    * is cached and will only subscribe for account ids that are not yet
    * in the cached states object. This behaviour can be overridden using
    * the `refresh` option. With `refresh`, all supplied account ids will
    * have their presence updated from the SIP server.
    * @param {Boolean} refresh - Force refreshing presence from the sip service.
    */
    async updatePresence(refresh) {
        if (this.status !== 'started') {
            this.app.logger.warn(`${this}cannot update presence without websocket connection.`)
            return
        }

        // Get the current account ids from localstorage.
        let widgetState = this.app.store.get('widgets')
        let accountIds = widgetState.contacts.list.map((c) => c.account_id)

        if (refresh) {
            // Set all colleagues to unavailable in the UI and
            // clear the states object.
            for (let accountId in this.states) {
                this.app.emit('sip:presence.update', {account_id: accountId, state: 'unavailable'})
            }
            this.states = {}
        } else {
            // Set the current cached in the UI early on.
            for (let accountId in this.states) {
                this.app.emit('sip:presence.update', {account_id: accountId, state: this.states[accountId].state})
            }
        }

        // Always unsubscribe lost contacts that are in cache, but not in
        // the accountIds refresh array.
        const oldCachedAccountIds = Object.keys(this.states).filter((k, v) => !accountIds.includes(Number(k)))

        this.app.logger.debug(`${this}SIP subscription unsubscribe cleanup for ${oldCachedAccountIds.length} accounts`)
        for (let accountId of oldCachedAccountIds) {
            this.unsubscribePresence(Number(accountId))
        }

        const accountIdsWithoutState = accountIds.filter((accountId) => !(accountId in this.states))
        this.app.logger.debug(`${this}SIP subscription update for ${accountIdsWithoutState.length} accounts`)

        if (accountIdsWithoutState.length) {
            this.app.emit('sip:presences.start_update')
            for (const accountId of accountIdsWithoutState) {
                // We could do this in parallel, but we don't to keep the load on
                // the websocket server low. Also subscribePresence has a fixed
                // timeout before it resolves the connected state, to further slow
                // down the presence requests.
                await this.subscribePresence(Number(accountId))
            }

            // Clear loading indicator in the ui.
            this.app.emit('sip:presences.updated')
        }
    }
}

module.exports = Sip
</code></pre>
</article>





        <hr>
        <footer>
            <strong>&copy; Devhouse Spindle</strong><br/>
            Documented with <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
        </footer>
    </div>
</div>

<script src="js/jquery.min.js"></script>
<script>

window.isApi = true
window.isManual = false
window.doc = {
    name: '',
    longname: '',
}

if (!doc.name) isApi = false

</script>
<script src="js/rtd.js"></script>
</body>
</html>
