
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Source: modules/availability/index.js | Vialer-js</title>
    <link type="text/css" rel="stylesheet" href="styles/font-awesome.min.css">
    <link type="text/css" rel="stylesheet" href="styles/main.css">

    
</head>
<body>
<div class="main-container">
    <input type="checkbox" id="nav-trigger" class="nav-trigger">
    <label for="nav-trigger" class="navicon-button x">
      <div class="navicon"></div>
    </label>
    <label for="nav-trigger" class="overlay"></label>
    <nav class="lnb" id="lnb">
        <div class="nav-search js-search">
            <div class="logo" style="width: 72px; height: 72px">
                <img src="logo-64.png" width="100%" height="100%">
            </div>
            <input type="text" placeholder="Search docs">
            <ul class="searched-list"></ul>
        </div>

        <div class="nav-main">
            <h1><a href="index.html" class="link">Vialer-js</a></h1>
            <span class="version">
            
                v2.0.14
            
            </span>
        </div>

        
        <ol class="nav-tab">
            <li id="api-tab">
                <a href="#api"><h4>Code</h4></a>
            </li>
            <li id="manuals-tab">
                <a href="#manuals"><h4>Manuals</h4></a>
            </li>
        </ol>
        

        <div class="scroll">
        <div class="nav-api hidden"><h3>Global</h3><ul><li class="nav-item"><a href="global.html#jitter">jitter</a></li><li class="nav-item"><a href="global.html#VialerApp">VialerApp</a></li></ul></div><div class="nav-manuals hidden"><h3>Manuals</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-deployment.html">Deployment</a>
                <div class="nav-item-sub hidden" id="deployment_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-development.html">Development</a>
                <div class="nav-item-sub hidden" id="development_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-install.html">Installation</a>
                <div class="nav-item-sub hidden" id="install_sub"></div>
            </li></ul></div><div class="nav-api hidden"><h3>Modules</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability.html">Availability</a>
                <div class="nav-item-sub hidden" id="module_Availability_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts.html">Contacts</a>
                <div class="nav-item-sub hidden" id="module_Contacts_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer.html">Dialer</a>
                <div class="nav-item-sub hidden" id="module_Dialer_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer.html">Observer</a>
                <div class="nav-item-sub hidden" id="module_Observer_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer.html#~getBlockedRoles">getBlockedRoles</a></a></li><li class="sub-nav-item"><a href="module-Observer.html#~getBlockedTagNames">getBlockedTagNames</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues.html">Queues</a>
                <div class="nav-item-sub hidden" id="module_Queues_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui.html">Ui</a>
                <div class="nav-item-sub hidden" id="module_Ui_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User.html">User</a>
                <div class="nav-item-sub hidden" id="module_User_sub"></div>
            </li></ul></div><div class="nav-api hidden"><h3>Classes</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Actions.html">Actions</a>
                <div class="nav-item-sub hidden" id="Actions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Analytics.html">Analytics</a>
                <div class="nav-item-sub hidden" id="Analytics_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Analytics.html#trackClickToDial">trackClickToDial</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Api.html">Api</a>
                <div class="nav-item-sub hidden" id="Api_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Api.html#setupClient">setupClient</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="App.html">App</a>
                <div class="nav-item-sub hidden" id="App_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="App.html#_init">_init</a></a></li><li class="sub-nav-item"><a href="App.html#getPlatformUrl">getPlatformUrl</a></a></li><li class="sub-nav-item"><a href="App.html#getWebsocketUrl">getWebsocketUrl</a></a></li><li class="sub-nav-item"><a href="App.html#reloadModules">reloadModules</a></a></li><li class="sub-nav-item"><a href="App.html#resetModules">resetModules</a></a></li><li class="sub-nav-item"><a href="App.html#restoreModules">restoreModules</a></a></li><li class="sub-nav-item"><a href="App.html#version">version</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="CallStatusApp.html">CallStatusApp</a>
                <div class="nav-item-sub hidden" id="CallStatusApp_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Logger.html">Logger</a>
                <div class="nav-item-sub hidden" id="Logger_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability-AvailabilityActions.html">AvailabilityActions</a>
                <div class="nav-item-sub hidden" id="module_Availability_AvailabilityActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Availability-AvailabilityActions.html#_background">_background</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityActions.html#_popup">_popup</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability-AvailabilityModule.html">AvailabilityModule</a>
                <div class="nav-item-sub hidden" id="module_Availability_AvailabilityModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#_load">_load</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#_restore">_restore</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#availabilityOptions">availabilityOptions</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#toggleAvailabilitySelect">toggleAvailabilitySelect</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts-ContactsActions.html">ContactsActions</a>
                <div class="nav-item-sub hidden" id="module_Contacts_ContactsActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts-ContactsModule.html">ContactsModule</a>
                <div class="nav-item-sub hidden" id="module_Contacts_ContactsModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Contacts-ContactsModule.html#_load">_load</a></a></li><li class="sub-nav-item"><a href="module-Contacts-ContactsModule.html#_restore">_restore</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer-DialerActions.html">DialerActions</a>
                <div class="nav-item-sub hidden" id="module_Dialer_DialerActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer-DialerModule.html">DialerModule</a>
                <div class="nav-item-sub hidden" id="module_Dialer_DialerModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#addContextMenuItem">addContextMenuItem</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#dial">dial</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#sanitizeNumber">sanitizeNumber</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#showCallstatus">showCallstatus</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#switchObserver">switchObserver</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#trimNumber">trimNumber</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer-ObserverModule.html">ObserverModule</a>
                <div class="nav-item-sub hidden" id="module_Observer_ObserverModule_sub"><div class="member-type">Members</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#ctdNode">ctdNode</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#iconElement">iconElement</a></a></li></ul><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#createNumberIconElement">createNumberIconElement</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#escapeHTML">escapeHTML</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#handleMutations">handleMutations</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#observePage">observePage</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#processPage">processPage</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#restorePhonenumbers">restorePhonenumbers</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#stopObserver">stopObserver</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer-Walker.html">Walker</a>
                <div class="nav-item-sub hidden" id="module_Observer_Walker_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-Walker.html#isBlockedElement">isBlockedElement</a></a></li><li class="sub-nav-item"><a href="module-Observer-Walker.html#skipNode">skipNode</a></a></li><li class="sub-nav-item"><a href="module-Observer-Walker.html#walkTheDOM">walkTheDOM</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues-QueuesActions.html">QueuesActions</a>
                <div class="nav-item-sub hidden" id="module_Queues_QueuesActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Queues-QueuesActions.html#_background">_background</a></a></li><li class="sub-nav-item"><a href="module-Queues-QueuesActions.html#_popup">_popup</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues-QueuesModule.html">QueuesModule</a>
                <div class="nav-item-sub hidden" id="module_Queues_QueuesModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Queues-QueuesModule.html#setQueueSizesTimer">setQueueSizesTimer</a></a></li><li class="sub-nav-item"><a href="module-Queues-QueuesModule.html#updateQueues">updateQueues</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui-UiActions.html">UiActions</a>
                <div class="nav-item-sub hidden" id="module_Ui_UiActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Ui-UiActions.html#_checkCloseMainPanel">_checkCloseMainPanel</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui-UiModule.html">UiModule</a>
                <div class="nav-item-sub hidden" id="module_Ui_UiModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Ui-UiModule.html#busyWidget">busyWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#closeWidget">closeWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#getWidget">getWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#isWidgetOpen">isWidgetOpen</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#login">login</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#openWidget">openWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#refreshWidgets">refreshWidgets</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetLoginButton">resetLoginButton</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetWidget">resetWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetWidgetState">resetWidgetState</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#restoreWidgetState">restoreWidgetState</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#showPopup">showPopup</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#unauthorizeWidget">unauthorizeWidget</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User-UserActions.html">UserActions</a>
                <div class="nav-item-sub hidden" id="module_User_UserActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User-UserModule.html">UserModule</a>
                <div class="nav-item-sub hidden" id="module_User_UserModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-User-UserModule.html#login">login</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Sip.html">Sip</a>
                <div class="nav-item-sub hidden" id="Sip_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Sip.html#connect">connect</a></a></li><li class="sub-nav-item"><a href="Sip.html#disconnect">disconnect</a></a></li><li class="sub-nav-item"><a href="Sip.html#initStack">initStack</a></a></li><li class="sub-nav-item"><a href="Sip.html#sipStatusEvent">sipStatusEvent</a></a></li><li class="sub-nav-item"><a href="Sip.html#subscribeEvent">subscribeEvent</a></a></li><li class="sub-nav-item"><a href="Sip.html#subscribePresence">subscribePresence</a></a></li><li class="sub-nav-item"><a href="Sip.html#unsubscribePresence">unsubscribePresence</a></a></li><li class="sub-nav-item"><a href="Sip.html#updatePresence">updatePresence</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Skeleton.html">Skeleton</a>
                <div class="nav-item-sub hidden" id="Skeleton_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Skeleton.html#_init">_init</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#emit">emit</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#getEnvironment">getEnvironment</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#ipcListener">ipcListener</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#on">on</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Store.html">Store</a>
                <div class="nav-item-sub hidden" id="Store_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Timer.html">Timer</a>
                <div class="nav-item-sub hidden" id="Timer_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Timer.html#increaseTimeout">increaseTimeout</a></a></li><li class="sub-nav-item"><a href="Timer.html#setTimeout">setTimeout</a></a></li></ul></div>
            </li></ul></div>
        </div>
    </nav>

    <div class="content">
        <ul class="breadcrumbs">
            <li><a href="index.html">Docs</a> Â»</li>
            <li>Source: modules/availability/index.js</li>
        </ul>
        <hr>
        



    
<article>
    <pre class="prettyprint source linenums"><code>/**
* @module Availability
*/
const AvailabilityActions = require('./actions')


/**
* The Availability module.
*/
class AvailabilityModule {

    /**
    * @param {ClickToDialApp} app - The application object.
    */
    constructor(app) {
        this.app = app
        this.hasUI = true
        this.app.modules.availability = this
        this.actions = new AvailabilityActions(app, this)
    }


    /**
    * Build an array of availability data that can be used to build
    * the availability select.
    * @param {Object} userdestination - Contains available phoneaccounts and
    * fixeddestinations to build the availability list from.
    * @param {String} selectedFixeddestinationId - Fixeddestination to select.
    * @param {String} selectedPhoneaccountId - Phoneaccount to select.
    * @returns {Array} - Data that is used to build the select element with.
    */
    availabilityOptions(userdestination, selectedFixeddestinationId, selectedPhoneaccountId) {
        this.app.logger.info(
            `${this}availabilityOptions selected [${selectedFixeddestinationId}, ${selectedPhoneaccountId}]`)
        // Destinations choices.
        const fixeddestinations = userdestination.fixeddestinations
        const phoneaccounts = userdestination.phoneaccounts

        let options = []
        fixeddestinations.forEach((fixeddestination) => {
            let option = {
                label: `${fixeddestination.phonenumber}/${fixeddestination.description}`,
                value: `fixeddestination-${fixeddestination.id}`,
            }
            if (parseInt(fixeddestination.id) === parseInt(selectedFixeddestinationId)) {
                this.app.logger.debug(`${this}set selected fixeddestination ${selectedFixeddestinationId}`)
                option.selected = true
            }
            // Add fixed destination to options.
            options.push(option)
        })
        phoneaccounts.forEach((phoneaccount) => {
            let option = {
                label: `${phoneaccount.internal_number}/${phoneaccount.description}`,
                value: `phoneaccount-${phoneaccount.id}`,
            }
            if (parseInt(phoneaccount.id) === parseInt(selectedPhoneaccountId)) {
                this.app.logger.debug(`${this}set selected phoneaccount ${selectedPhoneaccountId}`)
                option.selected = true
            }
            // Add phone account to options.
            options.push(option)
        })

        return options
    }


    selectUserdestination(type, id) {
        let data = {
            fixeddestination: null,
            phoneaccount: null,
        }
        if (type) data[type] = id

        // Save selection.
        let selectedUserdestinationId = this.app.store.get('user').selectedUserdestinationId

        this.app.api.client.put(`api/selecteduserdestination/${selectedUserdestinationId}/`, data).then((res) => {
            if (this.app.api.OK_STATUS.includes(res.status)) {
                this.app.logger.info(`${this}changed selected userdestination api request ok`)

                // Set an icon depending on whether the user is available.
                let icon = 'img/icon-red-small.png'
                if (id) {
                    icon = 'img/icon-green-small.png'
                }
                let widgetState = this.app.store.get('widgets')
                widgetState.availability.icon = icon
                this.app.store.set('widgets', widgetState)

                if (this.app.env.extension) {
                    if (widgetState.queues &amp;&amp; !widgetState.queues.selected) {
                        this.app.browser.browserAction.setIcon({path: icon})
                    }
                }

                let userData = this.app.store.get('user')
                userData.userdestination.selecteduserdestination.fixeddestination = data.fixeddestination
                userData.userdestination.selecteduserdestination.phoneaccount = data.phoneaccount
                this.app.store.set('user', userData)
            } else if (this.app.api.NOTOK_STATUS.includes(res.status)) {
                this._restore()
            }
        })
    }


    /**
    * Enable or disable the availability select based on the
    * `Are you available` radio button value.
    */
    toggleAvailabilitySelect() {
        const isAvailable = $('.availability-toggle [name="availability"]:checked').val() === 'yes'
        if (isAvailable) {
            this.app.logger.debug(`${this}user is available`)
            $('select#statusupdate').prop('disabled', false)
        } else {
            this.app.logger.debug(`${this}user is not available`)
            $('select#statusupdate').prop('disabled', true)
        }
    }


    toString() {
        return `${this.app}[availability] `
    }


    /**
    * Do an API request to get an update of the available userdestination
    * options when the module is loaded in the background.
    */
    _load() {
        if (this.app.env.extension &amp;&amp; !this.app.env.extension.background) return

        this.app.api.client.get('api/userdestination/').then((res) => {
            this.app.emit('ui:widget.reset', {name: 'availability'})
            if (this.app.api.OK_STATUS.includes(res.status)) {
                this.app.emit('availability:reset')
                // There is only one userdestination so objects[0] is the right
                // (and only) one.
                let userdestination = res.data.objects[0]
                let userData = this.app.store.get('user')
                if (userData) {
                    // Save userdestination in storage.
                    userData.userdestination = userdestination
                    // Save id for reference when changing the userdestination.
                    userData.selectedUserdestinationId = userdestination.selecteduserdestination.id
                    this.app.store.set('user', userData)
                }

                // Currently selected destination.
                let selectedFixeddestinationId = userdestination.selecteduserdestination.fixeddestination
                let selectedPhoneaccountId = userdestination.selecteduserdestination.phoneaccount

                // Build options for the availability dropdown.
                let options = this.availabilityOptions(userdestination, selectedFixeddestinationId,
                    selectedPhoneaccountId)

                let widgetState = this.app.store.get('widgets')
                widgetState.availability.options = options
                widgetState.availability.unauthorized = false
                this.app.store.set('widgets', widgetState)

                // Fill the dropdown with these choices.
                if (options.length) {
                    this.app.emit('availability:fill_select', {destinations: options})
                }

                // Set an icon depending on whether the user is available.
                let icon = 'img/icon-red-small.png'
                if (selectedFixeddestinationId || selectedPhoneaccountId) {
                    icon = 'img/icon-green-small.png'
                }
                this.app.logger.info(`${this}setting icon ${icon}`)

                if (this.app.env.extension) {
                    if (!widgetState.queues.selected) {
                        this.app.browser.browserAction.setIcon({path: icon})
                    }
                }

                // Save icon in storage.
                widgetState.availability.icon = icon
                this.app.store.set('widgets', widgetState)
            } else if (this.app.api.UNAUTHORIZED_STATUS.includes(res.status)) {
                this.app.logger.warn(`${this}unauthorized availability request`)
                // Update authorization status in the store.
                let widgetState = this.app.store.get('widgets')
                widgetState.availability.unauthorized = true
                this.app.store.set('widgets', widgetState)

                // Display an icon explaining the user lacks permissions to use
                // this feature of the plugin.
                this.app.emit('ui:widget.unauthorized', {name: 'availability'})
            }
        })
    }


    _reset() {
        this.app.emit('availability:reset')
        this.app.logger.info(`${this}set icon to grey`)
        if (this.app.env.extension) this.app.browser.browserAction.setIcon({path: 'img/icon-grey-small.png'})
    }


    /**
    * This is called when the popup refreshes and the background already
    * has processed all availability data.
    */
    _restore() {
        // Check if unauthorized.
        const widgetState = this.app.store.get('widgets')
        if (widgetState &amp;&amp; widgetState.availability.unauthorized) {
            this.app.emit('ui:widget.unauthorized', {name: 'availability'})
            return
        }

        // Restore options.
        const userData = this.app.store.get('user')
        if (userData &amp;&amp; userData.userdestination) {
            const userdestination = userData.userdestination
            const selectedFixeddestinationId = userdestination.selecteduserdestination.fixeddestination
            const selectedPhoneaccountId = userdestination.selecteduserdestination.phoneaccount
            this.app.logger.debug(
                `${this}restoring availability options from ${selectedPhoneaccountId}/${selectedFixeddestinationId}`)
            const options = this.availabilityOptions(userdestination, selectedFixeddestinationId,
                selectedPhoneaccountId)
            this.app.emit('availability:reset')
            if (options.length) {
                this.app.emit('availability:fill_select', {destinations: options})
            }
        }

        // Restore icon.
        if (widgetState &amp;&amp; widgetState.availability.icon) {
            if (!widgetState.queues.selected) {
                this.app.logger.info(`${this}set availability icon`)
                if (this.app.env.extension) {
                    this.app.browser.browserAction.setIcon({path: widgetState.availability.icon})
                }
            }
        }

        // Restore availability.
        this.app.emit('availability:refresh')
    }
}

module.exports = AvailabilityModule
</code></pre>
</article>





        <hr>
        <footer>
            <strong>&copy; Devhouse Spindle</strong><br/>
            Documented with <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
        </footer>
    </div>
</div>

<script src="js/jquery.min.js"></script>
<script>

window.isApi = true
window.isManual = false
window.doc = {
    name: '',
    longname: '',
}

if (!doc.name) isApi = false

</script>
<script src="js/rtd.js"></script>
</body>
</html>
