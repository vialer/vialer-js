
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Source: modules/dialer/index.js | Vialer-js</title>
    <link type="text/css" rel="stylesheet" href="styles/font-awesome.min.css">
    <link type="text/css" rel="stylesheet" href="styles/main.css">

    
</head>
<body>
<div class="main-container">
    <input type="checkbox" id="nav-trigger" class="nav-trigger">
    <label for="nav-trigger" class="navicon-button x">
      <div class="navicon"></div>
    </label>
    <label for="nav-trigger" class="overlay"></label>
    <nav class="lnb" id="lnb">
        <div class="nav-search js-search">
            <div class="logo" style="width: 72px; height: 72px">
                <img src="logo-64.png" width="100%" height="100%">
            </div>
            <input type="text" placeholder="Search docs">
            <ul class="searched-list"></ul>
        </div>

        <div class="nav-main">
            <h1><a href="index.html" class="link">Vialer-js</a></h1>
            <span class="version">
            
                v2.0.14
            
            </span>
        </div>

        
        <ol class="nav-tab">
            <li id="api-tab">
                <a href="#api"><h4>Code</h4></a>
            </li>
            <li id="manuals-tab">
                <a href="#manuals"><h4>Manuals</h4></a>
            </li>
        </ol>
        

        <div class="scroll">
        <div class="nav-api hidden"><h3>Global</h3><ul><li class="nav-item"><a href="global.html#jitter">jitter</a></li><li class="nav-item"><a href="global.html#VialerApp">VialerApp</a></li></ul></div><div class="nav-manuals hidden"><h3>Manuals</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-deployment.html">Deployment</a>
                <div class="nav-item-sub hidden" id="deployment_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-development.html">Development</a>
                <div class="nav-item-sub hidden" id="development_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-install.html">Installation</a>
                <div class="nav-item-sub hidden" id="install_sub"></div>
            </li></ul></div><div class="nav-api hidden"><h3>Modules</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability.html">Availability</a>
                <div class="nav-item-sub hidden" id="module_Availability_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts.html">Contacts</a>
                <div class="nav-item-sub hidden" id="module_Contacts_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer.html">Dialer</a>
                <div class="nav-item-sub hidden" id="module_Dialer_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer.html">Observer</a>
                <div class="nav-item-sub hidden" id="module_Observer_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer.html#~getBlockedRoles">getBlockedRoles</a></a></li><li class="sub-nav-item"><a href="module-Observer.html#~getBlockedTagNames">getBlockedTagNames</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues.html">Queues</a>
                <div class="nav-item-sub hidden" id="module_Queues_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui.html">Ui</a>
                <div class="nav-item-sub hidden" id="module_Ui_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User.html">User</a>
                <div class="nav-item-sub hidden" id="module_User_sub"></div>
            </li></ul></div><div class="nav-api hidden"><h3>Classes</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Actions.html">Actions</a>
                <div class="nav-item-sub hidden" id="Actions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Analytics.html">Analytics</a>
                <div class="nav-item-sub hidden" id="Analytics_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Analytics.html#trackClickToDial">trackClickToDial</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Api.html">Api</a>
                <div class="nav-item-sub hidden" id="Api_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Api.html#setupClient">setupClient</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="App.html">App</a>
                <div class="nav-item-sub hidden" id="App_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="App.html#_init">_init</a></a></li><li class="sub-nav-item"><a href="App.html#getPlatformUrl">getPlatformUrl</a></a></li><li class="sub-nav-item"><a href="App.html#getWebsocketUrl">getWebsocketUrl</a></a></li><li class="sub-nav-item"><a href="App.html#reloadModules">reloadModules</a></a></li><li class="sub-nav-item"><a href="App.html#resetModules">resetModules</a></a></li><li class="sub-nav-item"><a href="App.html#restoreModules">restoreModules</a></a></li><li class="sub-nav-item"><a href="App.html#version">version</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="CallStatusApp.html">CallStatusApp</a>
                <div class="nav-item-sub hidden" id="CallStatusApp_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Logger.html">Logger</a>
                <div class="nav-item-sub hidden" id="Logger_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability-AvailabilityActions.html">AvailabilityActions</a>
                <div class="nav-item-sub hidden" id="module_Availability_AvailabilityActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Availability-AvailabilityActions.html#_background">_background</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityActions.html#_popup">_popup</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability-AvailabilityModule.html">AvailabilityModule</a>
                <div class="nav-item-sub hidden" id="module_Availability_AvailabilityModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#_load">_load</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#_restore">_restore</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#availabilityOptions">availabilityOptions</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#toggleAvailabilitySelect">toggleAvailabilitySelect</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts-ContactsActions.html">ContactsActions</a>
                <div class="nav-item-sub hidden" id="module_Contacts_ContactsActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts-ContactsModule.html">ContactsModule</a>
                <div class="nav-item-sub hidden" id="module_Contacts_ContactsModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Contacts-ContactsModule.html#_load">_load</a></a></li><li class="sub-nav-item"><a href="module-Contacts-ContactsModule.html#_restore">_restore</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer-DialerActions.html">DialerActions</a>
                <div class="nav-item-sub hidden" id="module_Dialer_DialerActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer-DialerModule.html">DialerModule</a>
                <div class="nav-item-sub hidden" id="module_Dialer_DialerModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#addContextMenuItem">addContextMenuItem</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#dial">dial</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#sanitizeNumber">sanitizeNumber</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#showCallstatus">showCallstatus</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#switchObserver">switchObserver</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#trimNumber">trimNumber</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer-ObserverModule.html">ObserverModule</a>
                <div class="nav-item-sub hidden" id="module_Observer_ObserverModule_sub"><div class="member-type">Members</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#ctdNode">ctdNode</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#iconElement">iconElement</a></a></li></ul><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#createNumberIconElement">createNumberIconElement</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#escapeHTML">escapeHTML</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#handleMutations">handleMutations</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#observePage">observePage</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#processPage">processPage</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#restorePhonenumbers">restorePhonenumbers</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#stopObserver">stopObserver</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer-Walker.html">Walker</a>
                <div class="nav-item-sub hidden" id="module_Observer_Walker_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-Walker.html#isBlockedElement">isBlockedElement</a></a></li><li class="sub-nav-item"><a href="module-Observer-Walker.html#skipNode">skipNode</a></a></li><li class="sub-nav-item"><a href="module-Observer-Walker.html#walkTheDOM">walkTheDOM</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues-QueuesActions.html">QueuesActions</a>
                <div class="nav-item-sub hidden" id="module_Queues_QueuesActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Queues-QueuesActions.html#_background">_background</a></a></li><li class="sub-nav-item"><a href="module-Queues-QueuesActions.html#_popup">_popup</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues-QueuesModule.html">QueuesModule</a>
                <div class="nav-item-sub hidden" id="module_Queues_QueuesModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Queues-QueuesModule.html#setQueueSizesTimer">setQueueSizesTimer</a></a></li><li class="sub-nav-item"><a href="module-Queues-QueuesModule.html#updateQueues">updateQueues</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui-UiActions.html">UiActions</a>
                <div class="nav-item-sub hidden" id="module_Ui_UiActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Ui-UiActions.html#_checkCloseMainPanel">_checkCloseMainPanel</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui-UiModule.html">UiModule</a>
                <div class="nav-item-sub hidden" id="module_Ui_UiModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Ui-UiModule.html#busyWidget">busyWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#closeWidget">closeWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#getWidget">getWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#isWidgetOpen">isWidgetOpen</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#login">login</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#openWidget">openWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#refreshWidgets">refreshWidgets</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetLoginButton">resetLoginButton</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetWidget">resetWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetWidgetState">resetWidgetState</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#restoreWidgetState">restoreWidgetState</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#showPopup">showPopup</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#unauthorizeWidget">unauthorizeWidget</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User-UserActions.html">UserActions</a>
                <div class="nav-item-sub hidden" id="module_User_UserActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User-UserModule.html">UserModule</a>
                <div class="nav-item-sub hidden" id="module_User_UserModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-User-UserModule.html#login">login</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Sip.html">Sip</a>
                <div class="nav-item-sub hidden" id="Sip_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Sip.html#connect">connect</a></a></li><li class="sub-nav-item"><a href="Sip.html#disconnect">disconnect</a></a></li><li class="sub-nav-item"><a href="Sip.html#initStack">initStack</a></a></li><li class="sub-nav-item"><a href="Sip.html#sipStatusEvent">sipStatusEvent</a></a></li><li class="sub-nav-item"><a href="Sip.html#subscribeEvent">subscribeEvent</a></a></li><li class="sub-nav-item"><a href="Sip.html#subscribePresence">subscribePresence</a></a></li><li class="sub-nav-item"><a href="Sip.html#unsubscribePresence">unsubscribePresence</a></a></li><li class="sub-nav-item"><a href="Sip.html#updatePresence">updatePresence</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Skeleton.html">Skeleton</a>
                <div class="nav-item-sub hidden" id="Skeleton_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Skeleton.html#_init">_init</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#emit">emit</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#getEnvironment">getEnvironment</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#ipcListener">ipcListener</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#on">on</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Store.html">Store</a>
                <div class="nav-item-sub hidden" id="Store_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Timer.html">Timer</a>
                <div class="nav-item-sub hidden" id="Timer_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Timer.html#increaseTimeout">increaseTimeout</a></a></li><li class="sub-nav-item"><a href="Timer.html#setTimeout">setTimeout</a></a></li></ul></div>
            </li></ul></div>
        </div>
    </nav>

    <div class="content">
        <ul class="breadcrumbs">
            <li><a href="index.html">Docs</a> Â»</li>
            <li>Source: modules/dialer/index.js</li>
        </ul>
        <hr>
        



    
<article>
    <pre class="prettyprint source linenums"><code>/**
* @module Dialer
*/
const DialerActions = require('./actions')


/**
* The Dialer module. It takes care of actually dialing a phonenumber and
* updating the status about a call.
*/
class DialerModule {

    constructor(app, background = true) {
        this.app = app
        this.hasUI = false
        this._contextMenuItem = null
        // Hardcoded blacklist of sites because there is not yet a solution
        // that works for chrome and firefox using exclude site-urls.
        //
        // These sites are blocked primarily because they are javascript-heavy
        // which in turn leads to 100% cpu usage when trying to parse all the
        // mutations for too many seconds making it not responsive.
        //
        // the content script still tracks &lt;a href="tel:xxxx"> elements.
        this.blacklist = [
            '^chrome',
            // we prefer not to add icons in documents
            '^https?.*docs\\.google\\.com.*$',
            '^https?.*drive\\.google\\.com.*$',

            // Pages on these websites tend to grow too large to parse them in
            // a reasonable amount of time.
            '^https?.*bitbucket\\.org.*$',
            '^https?.*github\\.com.*$',
            '^https?.*rbcommons\\.com.*$',

            // This site has at least tel: support and uses javascript to open
            // a new web page when clicking the anchor element wrapping the
            // inserted icon.
            '^https?.*slack\\.com.*$',
        ]

        this.actions = new DialerActions(app, this)
    }


    /**
     * Add a right-click contextmenu item to all browser tabs.
     */
    addContextMenuItem() {
        this.app.logger.info(`${this}adding contextmenu`)
        this._contextMenuItem = this.app.browser.contextMenus.create({
            contexts: ['selection'],
            onclick: (info, _tab) => {
                this.app.modules.dialer.dial(info.selectionText, _tab)
                this.app.analytics.trackClickToDial('Webpage')
            },
            title: this.app.i18n.translate('contextMenuLabel'),
        })
    }


    /**
    * Calling this method with a provided tab will display the callstatus
    * on top of that tab in an iframe. The poller is stopped whenever the
    * callstatus dialog is closed or the returned status is final.
    * Without a provided tab(like when called from the colleagues widget)
    * there won't be a visible popup, but a html5 notification that is
    * triggered when the status changes.
    * @param {Number} bNumber - The number the user wants to call.
    * @param {Tab} [tab] - The tab from which the call was initialized,
    *                      or null to use notifcations.
    */
    async dial(bNumber, tab) {
        // Just make sure b_number is numbers only.
        bNumber = this.sanitizeNumber(bNumber).replace(/[^\d+]/g, '')
        const failedStatus = ['blacklisted', 'disconnected', 'failed_a', 'failed_b']
        let callid, callstatus

        // Start showing the callstatus dialog early on.
        // The actual callstatus feedback will be started after the
        // initial API requests.
        if (tab) {
            this.app.emit('dialer:status.show', {
                bNumber: bNumber,
                status: this.app.i18n.translate('clicktodialCallingText'),
            }, false, tab.id)
        } else {
            this.app.logger.notification(this.app.i18n.translate('clicktodialCallingText'))
        }

        // Get the callid from the API.
        const res = await this.app.api.client.post('api/clicktodial/', {b_number: bNumber})
        // Stop when an invalid http response is returned.
        if (this.app.api.NOTOK_STATUS.includes(res.status)) {
            this.app.emit('dialer:status.stop', {})
            this.app.logger.notification(this.app.i18n.translate('callStatusNotificationText'))
            return
        }

        // Stop when no callid is returned.
        if (!res.data || !res.data.callid) {
            this.app.emit('dialer:status.stop', {})
            this.app.logger.notification(this.app.i18n.translate('callStatusNotificationText'))
            return
        }

        callid = res.data.callid

        const callStatusPoller = async() => {
            // Get the actual callstatus from the API.
            const _res = await this.app.api.client.get(`api/clicktodial/${callid}/`)

            if (this.app.api.NOTOK_STATUS.includes(_res.status)) {
                this.app.emit('dialer:status.stop', {})
                // Something went wrong. Stop the timer.
                this.app.timer.stopTimer(`dialer:status.update-${callid}`)
                this.app.timer.unregisterTimer(`dialer:status.update-${callid}`)
                return
            }

            // Compare with the last callstatus, so we don't
            // perform unnecessary status updates.
            if (callstatus !== _res.data.status) {
                callstatus = _res.data.status

                if (tab) {
                    // Update panel on each call with latest status.
                    this.app.emit('dialer:status.update', {
                        callid: callid,
                        frame: 'callstatus',
                        status: this.getStatusMessage(callstatus, bNumber),
                    }, false, tab.id)
                } else {
                    if (failedStatus.includes(callstatus)) {
                        this.app.logger.notification(this.getStatusMessage(callstatus, bNumber), 'Vialer', false, 'warning')
                    } else {
                        this.app.logger.notification(this.getStatusMessage(callstatus, bNumber))
                    }

                }
            }

            // Stop the status timer when the call is in a final state.
            if (failedStatus.includes(callstatus)) {
                this.app.emit('dialer:status.stop', {})
                this.app.timer.stopTimer(`dialer:status.update-${callid}`)
                this.app.timer.unregisterTimer(`dialer:status.update-${callid}`)
            }
        }

        this.app.timer.registerTimer(`dialer:status.update-${callid}`, callStatusPoller)
        this.app.timer.setInterval(`dialer:status.update-${callid}`, 1500)

        if (tab) {
            // Pass the callid to the callstatus iframe. Timer will
            // be triggered by the callstatus script.
            this.app.emit('dialer:status.update', {callid: callid, frame: 'callstatus'}, false, tab.id)
        } else {
            // In notification mode, we start the timer immediatly.
            this.app.timer.startTimer(`dialer:status.update-${callid}`)
        }
    }


    getStatusMessage(status, bNumber) {
        let messages = {
            blacklisted: this.app.i18n.translate('clicktodialStatusBlacklisted'),
            confirm: this.app.i18n.translate('clicktodialStatusConfirm'),
            connected: this.app.i18n.translate('clicktodialStatusConnected'),
            dialing_a: this.app.i18n.translate('clicktodialStatusDialingA'),
            dialing_b: this.app.i18n.translate('clicktodialStatusDialingB', bNumber),
            disconnected: this.app.i18n.translate('clicktodialStatusDisconnected'),
            failed_a: this.app.i18n.translate('clicktodialStatusFailedA'),
            failed_b: this.app.i18n.translate('clicktodialStatusFailedB', bNumber),
        }

        let message = this.app.i18n.translate('clicktodialCallingText')
        if (messages.hasOwnProperty(status)) {
            message = messages[status]
        }

        return message
    }


    removeContextMenuItem() {
        this._contextMenuItem = null
        this.app.browser.contextMenus.removeAll()
    }


    /**
    * Process number to return a callable phone number.
    * @param {String} number - Number to clean.
    * @returns {String} - The cleaned number.
    */
    sanitizeNumber(number) {
        number = this.trimNumber(number)

        // Make numbers like +31(0) work.
        let digitsOnly = number.replace(/[^\d]/g, '')
        if (digitsOnly.substring(0, 3) === '310') {
            if (number.substring(3, 6) === '(0)') {
                number = number.replace(/^\+31\(0\)/, '+31')
            }
        }

        return number
    }


    /**
    * A tab triggers this function to show a status dialog.
    * @param {String} bNumber - Pass it asap to the callstatus page.
    * @param {String} status - Pass the initial status to the callstatus page.
    */
    showCallstatus(bNumber, status) {
        // Inline style for the injected callstatus iframe.
        let iframeStyle = {
            height: '100vh',
            left: '0',
            position: 'fixed',
            top: '0',
            width: '100vw',
            'z-index': '2147483647',
        }

        this.frame = $('&lt;iframe>', {
            scrolling: false,
            src: this.app.browser.runtime.getURL(`webext_callstatus.html?bNumber=${bNumber}&amp;status=${status}`),
            style: (function() {
                // Can't set !important with
                // .css("property", "value !important"),
                // so build a string to use as style.
                let style = ''
                for (let property in iframeStyle) {
                    style += `${property}: ${iframeStyle[property]} !important; `
                }
                return style
            }()),
        })

        $(this.frame).hide().on('load', (e) => {
            // Show and focus the callstatus iframe after loading.
            $(this.frame).show().get(0).contentWindow.focus()
        })
        $('html').append(this.frame)
    }


    /**
    * Called when the tab observer is initialized, by calling
    * `dialer:observer.ready` on the background. Determines whether the
    * DOM observer and c2d icons should be switched on or off.
    * The callback is done to the observer script.
    * @param {Object} tab - The tab that is requesting observer status.
    * @returns {Boolean} - Whether the observer should be listening.
    */
    switchObserver(tab) {
        if (!this.app.store.get('user')) {
            this.app.logger.info(`${this}not observing because user is not logged in`)
            this.removeContextMenuItem()
            return false
        }

        // Add the context menu to dial the selected number when
        // right mouse-clicking. The contextmenu is available, even when
        // c2d icons are disabled. Also, this can't be switched per tab,
        // so don't take blacklisted tabs in account.
        if (!this._contextMenuItem) this.addContextMenuItem()

        if (!this.app.store.get('c2d')) {
            this.app.logger.info(`${this}not observing because icons are disabled`)
            return false
        }

        // Test if one of the blacklisted sites matches.
        let blacklisted = false
        for (let i = 0; i &lt; this.blacklist.length; i++) {
            if (new RegExp(this.blacklist[i]).test(tab.url)) {
                blacklisted = true
                break
            }
        }

        if (blacklisted) {
            this.app.logger.info(`${this}not observing because this site is blacklisted: ${tab.url}`)
            return false
        }

        return true
    }


    toString() {
        return `${this.app}[dialer] `
    }


    /**
    * Return a number trimmed from white space.
    * @param {String} number - Number to trim.
    * @returns {String} - The whitespace trimmed number.
    */
    trimNumber(number) {
        // Force possible int to string.
        number = '' + number
        // Remove white space characters.
        return number.replace(/ /g, '')
    }


    _reset() {
        if (!this.app.env.extension) return
        // Called when logging the plugin out. Remove the contextmenu item.
        if (this._contextMenuItem) this.removeContextMenuItem()
        // Emit to each tab's running observer scripts that we don't want to
        // observe anymore.
        if (this.app.store.get('c2d')) {
            this.app.browser.tabs.query({}, (tabs) => {
                tabs.forEach((tab) => {
                    // Emit all observers on the tab to stop.
                    this.app.emit('observer:stop', {frame: 'observer'}, false, tab.id)
                })
            })
        }
    }
}

module.exports = DialerModule
</code></pre>
</article>





        <hr>
        <footer>
            <strong>&copy; Devhouse Spindle</strong><br/>
            Documented with <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
        </footer>
    </div>
</div>

<script src="js/jquery.min.js"></script>
<script>

window.isApi = true
window.isManual = false
window.doc = {
    name: '',
    longname: '',
}

if (!doc.name) isApi = false

</script>
<script src="js/rtd.js"></script>
</body>
</html>
