
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Source: modules/observer/index.js | Vialer-js</title>
    <link type="text/css" rel="stylesheet" href="styles/font-awesome.min.css">
    <link type="text/css" rel="stylesheet" href="styles/main.css">

    
</head>
<body>
<div class="main-container">
    <input type="checkbox" id="nav-trigger" class="nav-trigger">
    <label for="nav-trigger" class="navicon-button x">
      <div class="navicon"></div>
    </label>
    <label for="nav-trigger" class="overlay"></label>
    <nav class="lnb" id="lnb">
        <div class="nav-search js-search">
            <div class="logo" style="width: 72px; height: 72px">
                <img src="logo-64.png" width="100%" height="100%">
            </div>
            <input type="text" placeholder="Search docs">
            <ul class="searched-list"></ul>
        </div>

        <div class="nav-main">
            <h1><a href="index.html" class="link">Vialer-js</a></h1>
            <span class="version">
            
                v2.0.15
            
            </span>
        </div>

        
        <ol class="nav-tab">
            <li id="api-tab">
                <a href="#api"><h4>Code</h4></a>
            </li>
            <li id="manuals-tab">
                <a href="#manuals"><h4>Manuals</h4></a>
            </li>
        </ol>
        

        <div class="scroll">
        <div class="nav-api hidden"><h3>Global</h3><ul><li class="nav-item"><a href="global.html#jitter">jitter</a></li><li class="nav-item"><a href="global.html#VialerApp">VialerApp</a></li></ul></div><div class="nav-manuals hidden"><h3>Manuals</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-deployment.html">Deployment</a>
                <div class="nav-item-sub hidden" id="deployment_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-development.html">Development</a>
                <div class="nav-item-sub hidden" id="development_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-install.html">Installation</a>
                <div class="nav-item-sub hidden" id="install_sub"></div>
            </li></ul></div><div class="nav-api hidden"><h3>Modules</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability.html">Availability</a>
                <div class="nav-item-sub hidden" id="module_Availability_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts.html">Contacts</a>
                <div class="nav-item-sub hidden" id="module_Contacts_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer.html">Dialer</a>
                <div class="nav-item-sub hidden" id="module_Dialer_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer.html">Observer</a>
                <div class="nav-item-sub hidden" id="module_Observer_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer.html#~getBlockedRoles">getBlockedRoles</a></a></li><li class="sub-nav-item"><a href="module-Observer.html#~getBlockedTagNames">getBlockedTagNames</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues.html">Queues</a>
                <div class="nav-item-sub hidden" id="module_Queues_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui.html">Ui</a>
                <div class="nav-item-sub hidden" id="module_Ui_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User.html">User</a>
                <div class="nav-item-sub hidden" id="module_User_sub"></div>
            </li></ul></div><div class="nav-api hidden"><h3>Classes</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Actions.html">Actions</a>
                <div class="nav-item-sub hidden" id="Actions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Analytics.html">Analytics</a>
                <div class="nav-item-sub hidden" id="Analytics_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Analytics.html#trackClickToDial">trackClickToDial</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Api.html">Api</a>
                <div class="nav-item-sub hidden" id="Api_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Api.html#setupClient">setupClient</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="App.html">App</a>
                <div class="nav-item-sub hidden" id="App_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="App.html#_init">_init</a></a></li><li class="sub-nav-item"><a href="App.html#getPlatformUrl">getPlatformUrl</a></a></li><li class="sub-nav-item"><a href="App.html#getWebsocketUrl">getWebsocketUrl</a></a></li><li class="sub-nav-item"><a href="App.html#reloadModules">reloadModules</a></a></li><li class="sub-nav-item"><a href="App.html#resetModules">resetModules</a></a></li><li class="sub-nav-item"><a href="App.html#restoreModules">restoreModules</a></a></li><li class="sub-nav-item"><a href="App.html#version">version</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="CallStatusApp.html">CallStatusApp</a>
                <div class="nav-item-sub hidden" id="CallStatusApp_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Logger.html">Logger</a>
                <div class="nav-item-sub hidden" id="Logger_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability-AvailabilityActions.html">AvailabilityActions</a>
                <div class="nav-item-sub hidden" id="module_Availability_AvailabilityActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Availability-AvailabilityActions.html#_background">_background</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityActions.html#_popup">_popup</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Availability-AvailabilityModule.html">AvailabilityModule</a>
                <div class="nav-item-sub hidden" id="module_Availability_AvailabilityModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#_load">_load</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#_restore">_restore</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#availabilityOptions">availabilityOptions</a></a></li><li class="sub-nav-item"><a href="module-Availability-AvailabilityModule.html#toggleAvailabilitySelect">toggleAvailabilitySelect</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts-ContactsActions.html">ContactsActions</a>
                <div class="nav-item-sub hidden" id="module_Contacts_ContactsActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Contacts-ContactsModule.html">ContactsModule</a>
                <div class="nav-item-sub hidden" id="module_Contacts_ContactsModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Contacts-ContactsModule.html#_load">_load</a></a></li><li class="sub-nav-item"><a href="module-Contacts-ContactsModule.html#_restore">_restore</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer-DialerActions.html">DialerActions</a>
                <div class="nav-item-sub hidden" id="module_Dialer_DialerActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Dialer-DialerModule.html">DialerModule</a>
                <div class="nav-item-sub hidden" id="module_Dialer_DialerModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#addContextMenuItem">addContextMenuItem</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#dial">dial</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#sanitizeNumber">sanitizeNumber</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#showCallstatus">showCallstatus</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#switchObserver">switchObserver</a></a></li><li class="sub-nav-item"><a href="module-Dialer-DialerModule.html#trimNumber">trimNumber</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer-ObserverModule.html">ObserverModule</a>
                <div class="nav-item-sub hidden" id="module_Observer_ObserverModule_sub"><div class="member-type">Members</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#ctdNode">ctdNode</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#iconElement">iconElement</a></a></li></ul><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#createNumberIconElement">createNumberIconElement</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#escapeHTML">escapeHTML</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#handleMutations">handleMutations</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#observePage">observePage</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#processPage">processPage</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#restorePhonenumbers">restorePhonenumbers</a></a></li><li class="sub-nav-item"><a href="module-Observer-ObserverModule.html#stopObserver">stopObserver</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Observer-Walker.html">Walker</a>
                <div class="nav-item-sub hidden" id="module_Observer_Walker_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Observer-Walker.html#isBlockedElement">isBlockedElement</a></a></li><li class="sub-nav-item"><a href="module-Observer-Walker.html#skipNode">skipNode</a></a></li><li class="sub-nav-item"><a href="module-Observer-Walker.html#walkTheDOM">walkTheDOM</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues-QueuesActions.html">QueuesActions</a>
                <div class="nav-item-sub hidden" id="module_Queues_QueuesActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Queues-QueuesActions.html#_background">_background</a></a></li><li class="sub-nav-item"><a href="module-Queues-QueuesActions.html#_popup">_popup</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Queues-QueuesModule.html">QueuesModule</a>
                <div class="nav-item-sub hidden" id="module_Queues_QueuesModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Queues-QueuesModule.html#setQueueSizesTimer">setQueueSizesTimer</a></a></li><li class="sub-nav-item"><a href="module-Queues-QueuesModule.html#updateQueues">updateQueues</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui-UiActions.html">UiActions</a>
                <div class="nav-item-sub hidden" id="module_Ui_UiActions_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Ui-UiActions.html#_checkCloseMainPanel">_checkCloseMainPanel</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-Ui-UiModule.html">UiModule</a>
                <div class="nav-item-sub hidden" id="module_Ui_UiModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-Ui-UiModule.html#busyWidget">busyWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#closeWidget">closeWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#getWidget">getWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#isWidgetOpen">isWidgetOpen</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#login">login</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#openWidget">openWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#refreshWidgets">refreshWidgets</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetLoginButton">resetLoginButton</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetWidget">resetWidget</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#resetWidgetState">resetWidgetState</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#restoreWidgetState">restoreWidgetState</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#showPopup">showPopup</a></a></li><li class="sub-nav-item"><a href="module-Ui-UiModule.html#unauthorizeWidget">unauthorizeWidget</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User-UserActions.html">UserActions</a>
                <div class="nav-item-sub hidden" id="module_User_UserActions_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-User-UserModule.html">UserModule</a>
                <div class="nav-item-sub hidden" id="module_User_UserModule_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-User-UserModule.html#login">login</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Sip.html">Sip</a>
                <div class="nav-item-sub hidden" id="Sip_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Sip.html#connect">connect</a></a></li><li class="sub-nav-item"><a href="Sip.html#disconnect">disconnect</a></a></li><li class="sub-nav-item"><a href="Sip.html#initStack">initStack</a></a></li><li class="sub-nav-item"><a href="Sip.html#sipStatusEvent">sipStatusEvent</a></a></li><li class="sub-nav-item"><a href="Sip.html#subscribeEvent">subscribeEvent</a></a></li><li class="sub-nav-item"><a href="Sip.html#subscribePresence">subscribePresence</a></a></li><li class="sub-nav-item"><a href="Sip.html#unsubscribePresence">unsubscribePresence</a></a></li><li class="sub-nav-item"><a href="Sip.html#updatePresence">updatePresence</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Skeleton.html">Skeleton</a>
                <div class="nav-item-sub hidden" id="Skeleton_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Skeleton.html#_init">_init</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#emit">emit</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#getEnvironment">getEnvironment</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#ipcListener">ipcListener</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#on">on</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Store.html">Store</a>
                <div class="nav-item-sub hidden" id="Store_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Timer.html">Timer</a>
                <div class="nav-item-sub hidden" id="Timer_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Timer.html#increaseTimeout">increaseTimeout</a></a></li><li class="sub-nav-item"><a href="Timer.html#setTimeout">setTimeout</a></a></li></ul></div>
            </li></ul></div>
        </div>
    </nav>

    <div class="content">
        <ul class="breadcrumbs">
            <li><a href="index.html">Docs</a> Â»</li>
            <li>Source: modules/observer/index.js</li>
        </ul>
        <hr>
        



    
<article>
    <pre class="prettyprint source linenums"><code>/**
* @module Observer
*/
// Identify our elements with these class names.
const phoneElementClassName = 'vialer-phone-number'
const phoneIconClassName = 'vialer-icon'

const Walker = require('./walker')


/**
 * The Observer module. Injected in all tabs and all its frames.
 */
class ObserverModule {

    constructor(app) {
        this.app = app
        this.hasUI = false
        this.parsers = require('./parsers')
        this.walker = new Walker(this.app)
        // Search and insert icons after mutations.
        this.observer = null
        this.handleMutationsTimeout = null
        this.parkedNodes = []

        this.printStyle = $(
            `&lt;link rel="stylesheet" href="${this.app.browser.runtime.getURL('css/webext_print.css')}" media="print">`)

        /**
        * Stop listening to DOM mutations. Triggered when
        * the user logs out.
        */
        this.app.on('observer:stop', (data) => {
            this.stopObserver()
            // Remove icons.
            this.restorePhonenumbers()
            // Remove our stylesheet.
            $(this.printStyle).remove()
        })


        // Manually trigger to observe the current tab.
        this.app.on('observer:start', (data) => {
            this.processPage()
        })


        /**
        * Signal the background that the observer has been loaded and is
        * ready to look for phone numbers if the background demands it.
        */
        this.app.emit('dialer:observer.ready', {
            callback: (data) => {
                // Don't start observing, unless the observe property is true.
                if (!data.observe) return

                if (window !== window.top &amp;&amp; !(document.body.offsetWidth > 0 || document.body.offsetHeight > 0)) {
                    // Wait for this hidden iframe to become visible, before
                    // starting the observer.
                    $(window).on('resize', () => {
                        this.processPage()
                        // No reason to wait for more resize events.
                        $(window).off('resize')
                    })
                } else {
                    this.processPage()
                }
            },
        })

        /**
        * Handle a click on a click-to-dial icon next to a phonenumber within
        * a tab. Use the number in the attribute `data-number`.
        */
        $('body').on('click', `.${phoneIconClassName}`, (e) => {
            // Don't process the click when the icon has
            // a disabled property set.
            if ($(e.currentTarget).attr('disabled')) {
                e.preventDefault()
                return
            }

            if ($(e.currentTarget).attr('data-number') &amp;&amp;
                $(e.currentTarget).parents(`.${phoneElementClassName}`).length) {
                // Disable all c2d icons until the tab is notified
                // by the callstatus that it wants to close again.
                $(`.${phoneIconClassName}`).each((i, el) => {
                    $(el).attr('disabled', true)
                })
                $(e.currentTarget).blur()

                // Don't do anything with this click in the actual page.
                e.preventDefault()
                e.stopPropagation()
                e.stopImmediatePropagation()

                const b_number = $(e.currentTarget).attr('data-number')
                this.app.emit('dialer:dial', {
                    analytics: 'Webpage',
                    b_number: b_number,
                })
            }
        })

        /**
        * Handle the event when a link is clicked that contains
        * &lt;a href="tel:">&lt;/a>.
        */
        $('body').on('click', '[href^="tel:"]', (e) => {
            $(e.currentTarget).blur()
            // Don't do anything with this click in the actual page.
            e.preventDefault()
            e.stopPropagation()
            e.stopImmediatePropagation()

            // Dial the b_number.
            const bNumber = $(e.currentTarget).attr('href').substring(4)
            this.app.emit('dialer:dial', {
                analytics: 'Webpage',
                b_number: bNumber,
            })
        })
    }


    /**
    * Returns a new `&lt;ctd>&lt;/ctd>` node, that will wrap the phonenumber
    * and the click-to-dial icon.
    */
    get ctdNode() {
        let ctd = document.createElement('ctd')
        ctd.setAttribute('style', 'font-style: inherit; font-family: inherit;')
        ctd.classList.add(phoneElementClassName)
        return ctd
    }


    /**
    * Element that shows the icon and triggers a call.
    */
    get iconElement() {
        let a = document.createElement('a')
        a.setAttribute('style', this.iconStyle)
        a.setAttribute('href', '')
        a.classList.add(phoneIconClassName)
        return a
    }


    get iconStyle() {
        let iconStyle = {
            '-moz-border-radius': '9px !important',
            '-moz-box-shadow': '0 1px 1px rgba(0, 0, 0, 0.2) !important',
            'background-color': 'transparent !important',
            'background-image': `url("${this.app.browser.runtime.getURL('img/icon-c2d.png')}")`,
            'background-position': 'center center',
            'background-repeat': 'no-repeat',
            'border-radius': '9px !important',
            bottom: '-3px !important',
            'box-shadow': '0 1px 1px rgba(0, 0, 0, 0.2) !important',
            display: 'inline-block',
            height: '18px !important',
            'line-height': '18px !important',
            margin: '0 4px !important',
            padding: '0 !important',
            position: 'relative !important',
            width: '18px !important',
        }
        let style = ''
        for (let property in iconStyle) {
            style += `${property}: ${iconStyle[property]}; `
        }
        return style
    }


    /**
    * Create an HTML element containing an anchor with a phone icon with
    * the phone number in a data attribute.
    * @param {String} number - Number to use for the icon.
    * @returns {Node} - Newly created p element.
    */
    createNumberIconElement(number) {
        let icon = this.iconElement.cloneNode(false)
        // Add properties unique for "number".
        icon.setAttribute('data-number', number)
        icon.classList.add(`c2d-icon-${number}`)
        // Wrap in element so ".innerHTML" contains the icon HTML.
        let wrapper = document.createElement('p')
        wrapper.appendChild(icon)
        return wrapper
    }


    doInsert(root) {
        let pause = !!root
        if (pause) this.stopObserver()
        root = root || document.body

        // Walk the DOM looking for elements to parse, but block reasonably
        // sized pages to prevent locking the page.
        let childrenLength = $(root).find('*').length // no lookup costs
        if (childrenLength &lt; 2001) {
            this.app.logger.debug(`${this}scanning ${childrenLength} elements`)

            this.walker.walkTheDOM(root, (currentNode) => {
                // Scan using every available parser.
                this.parsers.forEach((localeParser) => {
                    let parser = localeParser[1]()
                    // Transform Text node to HTML-capable node, to
                    // - deal with html-entities (&amp;nbsp;, &amp;lt;, etc.) since
                    // they mess up the start/end from matches when reading
                    // from node.data, and
                    // - enable inserting the icon html
                    // (doesn't work with a text node)
                    let replacementNode = this.ctdNode.cloneNode(false)
                    replacementNode.textContent = currentNode.data
                    replacementNode.innerHTML = this.escapeHTML(currentNode.data)

                    let matches = parser.parse(replacementNode.innerHTML)
                    if (matches.length) {
                        if (!parser.isBlockingNode(currentNode.previousElementSibling) &amp;&amp;
                                !parser.isBlockingNode(currentNode.parentNode.previousElementSibling)) {

                            matches.reverse().forEach((match) => {
                                let numberIconElement = this.createNumberIconElement(match.number)

                                // prefix icon with match (==number)
                                let originalText = replacementNode.innerHTML.slice(match.start, match.end)
                                numberIconElement.innerHTML = `${originalText} ${numberIconElement.innerHTML}`

                                let before = replacementNode.innerHTML.slice(0, match.start)
                                let after = replacementNode.innerHTML.slice(match.end)
                                replacementNode.innerHTML = before + numberIconElement.innerHTML + after
                            })

                            currentNode.parentNode.insertBefore(replacementNode, currentNode)
                            currentNode.parentNode.removeChild(currentNode)
                        }
                    }
                })
            })
        } else {
            this.app.logger.debug(`${this}not scanning ${childrenLength} elements`)
        }

        if (pause) {
            this.observePage()
        }
    }


    /**
    * Injects icons in the page and start observing the page for changes.
    */
    processPage() {
        this.app.logger.debug(`${this}start observing`)
        // Inject our print stylesheet.
        $('head').append(this.printStyle)
        // Insert icons.
        const before = new Date().getTime()
        this.doInsert()
        this.app.logger.debug(`${this}doInsert (processPage) took`, new Date().getTime() - before)
        // Start listening to DOM mutations.
        this.observePage()
    }


    /**
    * Escape HTML chars when assigning text to innerHTML.
    * @param {String} str - The string to escape html from.
    * @returns {String} - The HTML escaped string.
    */
    escapeHTML(str) {
        const replacements = {
            '"': '&amp;quot;',
            '&amp;': '&amp;amp;',
            '&lt;': '&amp;lt;',
            '>': '&amp;gt;',
        }
        return str.replace(/[&amp;"&lt;>]/g, (m) => replacements[m])
    }



    /**
     * Process parked DOM mutations.
     */
    handleMutations() {
        // Copy and clear parkedNodes.
        let _parkedNodes = this.parkedNodes.slice()
        this.parkedNodes = []
        // Handle mutations if it probably isn't too much to handle
        // (current limit is totally random).
        if (_parkedNodes.length &lt; 151) {
            this.app.logger.debug(`${this}processing ${_parkedNodes.length} parked nodes.`)
            let batchSize = 40 // random size
            for (let i = 0; i &lt; Math.ceil(_parkedNodes.length / batchSize); i++) {
                ((index) => {
                    setTimeout(() => {
                        for (let j = index * batchSize; j &lt; (index + 1) * batchSize; j++) {
                            let node = _parkedNodes[j]
                            let stillInDocument = document.contains(node) // no lookup costs
                            if (stillInDocument) {
                                let before = new Date().getTime()
                                this.doInsert(node)
                                this.app.logger.debug(
                                    `${this}doInsert (handleMutations) took`, new Date().getTime() - before)
                            } else {
                                this.app.logger.debug(`${this}doInsert (handleMutations) took 0 - removed node`)
                            }
                        }
                    }, 0) // Push back execution to the end on the current event stack.
                })(i)
            }
        }
    }


    /**
     * Observer start: listen for DOM mutations and let `handleMutations`
     * process them.
     */
    observePage() {
        if (!this.observer) {
            this.observer = new MutationObserver((mutations) => {
                if (this.handleMutationsTimeout) {
                    // Don't handle the mutations yet after all.
                    clearTimeout(this.handleMutationsTimeout)
                }

                mutations.forEach((mutation) => {
                    // Filter mutations to park.
                    if (mutation.addedNodes.length) {
                        $.each(mutation.addedNodes, (index, addedNode) => {
                            if (!this.walker.skipNode(addedNode)) {
                                this.parkedNodes.push(addedNode)
                            }
                        })
                    } else if (!mutation.removedNodes.length &amp;&amp; mutation.target) {
                        if (!this.walker.skipNode(mutation.target)) {
                            this.parkedNodes.push(mutation.target)
                        }
                    }
                })

                // Assuming nothing happens, scan the nodes in 500 ms - after
                // this the page should've been done dealing with the mutations.
                if (this.parkedNodes.length) {
                    this.handleMutationsTimeout = setTimeout(this.handleMutations.bind(this), 500)
                }
            })
        }

        if (this.observer) {
            this.observer.observe(document.body, {
                childList: true,
                subtree: true,
            })
        }
    }


    /**
     * Observer stop: simply stop listening to DOM mutations.
     */
    stopObserver() {
        if (this.observer) {
            this.observer.disconnect()
        }
    }


    toString() {
        return `${this.app}[observer] `
    }


    /**
     * Restore the original numbers by replacing all ctd nodes with a new
     * text node containing the phonenumber.
     */
    restorePhonenumbers() {
        document.querySelectorAll('ctd').forEach((el) => {
            el.parentNode.replaceChild(document.createTextNode(el.textContent), el)
        })
    }
}

module.exports = ObserverModule
</code></pre>
</article>





        <hr>
        <footer>
            <strong>&copy; Devhouse Spindle</strong><br/>
            Documented with <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
        </footer>
    </div>
</div>

<script src="js/jquery.min.js"></script>
<script>

window.isApi = true
window.isManual = false
window.doc = {
    name: '',
    longname: '',
}

if (!doc.name) isApi = false

</script>
<script src="js/rtd.js"></script>
</body>
</html>
